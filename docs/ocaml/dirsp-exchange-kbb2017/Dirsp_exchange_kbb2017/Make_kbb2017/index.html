<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make_kbb2017 (dirsp-exchange-kbb2017.Dirsp_exchange_kbb2017.Make_kbb2017)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">dirsp-exchange-kbb2017</a> &#x00BB; <a href="../index.html">Dirsp_exchange_kbb2017</a> &#x00BB; Make_kbb2017</nav><h1>Module <code>Dirsp_exchange_kbb2017.Make_kbb2017</code></h1><p>Makes the Kobeissi, Bhargavan and Blanchet (KBB2017) verified security protocol that will delegate to a Proscript runtime library of cryptographic primitives.</p><h2 id="basics"><a href="#basics" class="anchor"></a>Basics</h2><pre><code class="ml">module P       = Dirsp_proscript_mirage.Make()
module C       = P.Crypto
module ED25519 = P.Crypto.ED25519
module E       = P.Encoding
module K       = Dirsp_exchange_kbb2017.Make_kbb2017(P)
module U       = K.UTIL
module T       = K.TOPLEVEL
module KEY     = K.Type_key
module MSG     = K.Type_msg

(* Alice sends a message to Bob *)
let aliceSessionWithBob = T.newSession (* ... supply several keys ... *) ;;
let aliceToBobSendOutput = T.send
  aliceIdentityKey
  aliceSessionWithBob
  (P.of_string &quot;Hi Bob!&quot;)

(* Now you can send the output from Alice to Bob.
   Let's switch to Bob's computer. He gets notified of a new mssage (that is your responsibility)
   and then does ...  *)

let bobSessionWithAlice = T.newSession (* ... supply several keys ... *);;
let bobFromAliceReceiveOutput = T.recv
  bobIdentityKey
  bobSignedPreKey
  bobSessionWithAlice
  theEncryptedMessageBobReceivedFromAlice
assert (bobFromAliceReceiveOutput.output.valid)
Format.printf &quot;Bob just received a new message: %s\n&quot;
  (bobFromAliceReceiveOutput.plaintext |&gt; P.to_bytes |&gt; Bytes.to_string)</code></pre><p><a href="../index.html"><code>Dirsp_exchange_kbb2017</code></a> has a more detailed example.</p><p>The functor <code>Make_kbb2017</code> creates an implementation of the X3DH and Double Rachet protocols. It makes use of a Javascript implementation of the Signal Protocol that was used to prove the soundness of a variant of the &quot;Signal Protocol&quot; (aka X3DH + Double Ratchet) in the paper by the Prosecco research group</p><pre>    Nadim Kobeissi, Karthikeyan Bhargavan, Bruno Blanchet.
    Automated Verification for Secure Messaging Protocols
      and Their Implementations: A Symbolic and Computational Approach.
    2nd IEEE European Symposium on Security and Privacy , Apr 2017, Paris, France.
    pp.435 - 450, 2017, &lt;https://www.ieee-security.org/TC/EuroSP2017/&gt;.
    &lt;10.1109/EuroSP.2017.38&gt;. &lt;hal-01575923&gt;</pre><p>We call that paper’s algorithm the Kobeissi, Bhargavan and Blanchet (KBB2017) algorithm to both recognize the paper’s authors and to avoid the use of the trademark &quot;Signal&quot;. Please be aware that the variant used in the Automated Verification paper deviates from the original Open Whisper System publications. <code>Make_kbb2017</code> corresponds to the variant in the Automated Verification paper.</p><h2 id="implementation"><a href="#implementation" class="anchor"></a>Implementation</h2><p>The Automated Verification paper has a <a href="https://github.com/Inria-Prosecco/proscript-messaging">source code repository called proscript-messaging</a>. The authors of <code>dirsp-exchange</code> have a <a href="https://github.com/diskuv/proscript-messaging">clone of that repository</a> for audit redundancy.</p><p>The <code>proscript-messaging</code> directory contains an implementation of X3DH and Double Ratchet in a restricted form of Javascript (&quot;ProScript&quot;) suited to security analysis. There is also a small security library written in ProScript called the ProScript Cryptographic Library (PSCL) containing security primitives like SHA-256. <code>proscript-messaging</code> also contains an <em>OCaml</em> parser and an Abstract Syntax Tree (AST) for that restricted Javascript, which it uses to translate the X3DH and Double Ratchet implementations into a few other languages.</p><p>With <code>Make_kbb2017</code>:</p><ul><li>the ProScript implementations of X3DH and Double Ratchet are used <em>without modification</em></li><li>the OCaml parser and OCaml AST are used <em>without modification</em></li><li>there is a hand-written translator from ProScript into OCaml that makes use of the OCaml AST</li><li>there is this functor that wraps the X3DH and Double Ratchet auto-translated OCaml into idiomatic OCaml</li></ul><p>Please see the documentation generated from <code>src-proscript/proscript-messaging/TRANSLATING_PROSCRIPT_INTO_OCAML.rst</code> for complete details.</p><h2 id="managing-state"><a href="#managing-state" class="anchor"></a>Managing State</h2><p>The second parameter named <code>them</code> in <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/module-type-PROTOCOL/TOPLEVEL/index.html#val-send"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.PROTOCOL.TOPLEVEL.send</code></a> and <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/module-type-PROTOCOL/TOPLEVEL/index.html#val-recv"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.PROTOCOL.TOPLEVEL.recv</code></a> requires special handling. You must set <code>them</code> to the last <code>record_them</code> used in a conversation.</p><p>We suggest that you use the next section &quot;Serialization and Deserialization&quot; so you can save the last <code>record_them</code> into secure storage, and have it available when you need to <code>send</code> or <code>recv</code>.</p><p>Capture the record from the following scenarios:</p><ol><li>When you create a session with <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/module-type-PROTOCOL/TOPLEVEL/index.html#val-newSession"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.PROTOCOL.TOPLEVEL.newSession</code></a>, the return value is a <code>record_them</code>.</li><li>When you send a message with <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/module-type-PROTOCOL/TOPLEVEL/index.html#val-send"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.PROTOCOL.TOPLEVEL.send</code></a>, the return value has an <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/index.html#type-record_sendoutput.them"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.record_sendoutput.them</code></a> field which is a <code>record_them</code>.</li><li>When you receive a message with <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/module-type-PROTOCOL/TOPLEVEL/index.html#val-recv"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.PROTOCOL.TOPLEVEL.recv</code></a>, the return value has an <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/index.html#type-record_recvoutput.them"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.record_recvoutput.them</code></a> field which is a <code>record_them</code>.</li></ol><h2 id="Marshalling"><a href="#Marshalling" class="anchor"></a>Serialization and Deserialization</h2><p>The records can all be serialized into and out of protobuf. Here we encode <code>bobFromAliceReceiveOutput2.them</code> from the <code>Summary</code> into bytes, and then we decode those bytes back into its original type <a href="../../Dirsp_exchange_kbb2017__/Kobeissi_bhargavan_blanchet_intf/index.html#type-record_them"><code>Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf.record_them</code></a>:</p><pre><code class="ml">module KBBI = Dirsp_exchange_kbb2017__.Kobeissi_bhargavan_blanchet_intf

let encoder = KBBI.record_them_to_protobuf P.t_to_protobuf
let decoder = KBBI.record_them_from_protobuf P.t_from_protobuf

let (encoded_bytes: Bytes.t) =
  Protobuf.Encoder.encode_exn
    encoder
    bobFromAliceReceiveOutput2.them
(* You can save the [encoded_bytes] in secure storage *)

let (decoded_value: K.t KBBI.record_them) =
  Protobuf.Decoder.decode_exn
    decoder
    encoded_bytes
(* Now you have a [record_them] *)</code></pre><p>The complete list of parametric records that can be saved is at <code>Kobeissi_bhargavan_blanchet_intf</code>.</p><p>See <a href="https://github.com/ocaml-ppx/ppx_deriving_protobuf">ppx_deriving_protobuf</a> for details about the protobuf encoding.</p></header><h3 class="heading">Parameters</h3><ul><li><code><a href="argument-1-ProScript/index.html">ProScript</a> : <a href="../../../dirsp-proscript/Dirsp_proscript/index.html#module-type-S">Dirsp_proscript.S</a></code></li></ul><h3 class="heading">Signature</h3><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code><code> = <a href="argument-1-ProScript/index.html#type-t">ProScript.t</a></code></dt><dd><p>The type that will be used to represent contiguous bytes in the protocol; typically Bytes.t or Cstruct.t</p></dd></dl><dl><dt class="spec type" id="type-t_aes_decrypted"><a href="#type-t_aes_decrypted" class="anchor"></a><code><span class="keyword">type</span> t_aes_decrypted</code></dt><dd><p>An internal type representing a decrypted AES message</p></dd></dl><dl><dt class="spec module" id="module-TOPLEVEL"><a href="#module-TOPLEVEL" class="anchor"></a><code><span class="keyword">module</span> <a href="TOPLEVEL/index.html">TOPLEVEL</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Entry point for sending and receiving messages while maintaining a KBB2017 session.</p></dd></dl><dl><dt class="spec module" id="module-Type_key"><a href="#module-Type_key" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_key/index.html">Type_key</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A private or public key</p></dd></dl><dl><dt class="spec module" id="module-Type_iv"><a href="#module-Type_iv" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_iv/index.html">Type_iv</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>An initialization vector</p></dd></dl><dl><dt class="spec module" id="module-Type_msg"><a href="#module-Type_msg" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_msg/index.html">Type_msg</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A message</p></dd></dl><dl><dt class="spec module" id="module-Type_keypair"><a href="#module-Type_keypair" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_keypair/index.html">Type_keypair</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A public and private keypair</p></dd></dl><dl><dt class="spec module" id="module-Type_them"><a href="#module-Type_them" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_them/index.html">Type_them</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A session tracking the other party in a conversation</p></dd></dl><dl><dt class="spec module" id="module-Type_sendoutput"><a href="#module-Type_sendoutput" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_sendoutput/index.html">Type_sendoutput</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The updates to your record of the other party <em>that should be persisted</em> after sending a message</p></dd></dl><dl><dt class="spec module" id="module-Type_recvoutput"><a href="#module-Type_recvoutput" class="anchor"></a><code><span class="keyword">module</span> <a href="Type_recvoutput/index.html">Type_recvoutput</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The updates to your record of the other party <em>that should be persisted</em> after receiving a message</p></dd></dl><dl><dt class="spec module" id="module-UTIL"><a href="#module-UTIL" class="anchor"></a><code><span class="keyword">module</span> <a href="UTIL/index.html">UTIL</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Cryptographic helpers used in KBB2017</p></dd></dl><dl><dt class="spec module" id="module-RATCHET"><a href="#module-RATCHET" class="anchor"></a><code><span class="keyword">module</span> <a href="RATCHET/index.html">RATCHET</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Double Ratchet algorithm</p></dd></dl><dl><dt class="spec module" id="module-HANDLE"><a href="#module-HANDLE" class="anchor"></a><code><span class="keyword">module</span> <a href="HANDLE/index.html">HANDLE</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>KBB2017 session update logic</p></dd></dl></div></body></html>