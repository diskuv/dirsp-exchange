

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Integration Guide &mdash; Diskuv Implementations of Research Security Protocols  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="FAQs" href="PS2OCAML_FAQS.html" />
    <link rel="prev" title="Translating ProScript to OCaml" href="PS2OCAML.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Diskuv Implementations of Research Security Protocols
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../OCAML_LIBRARIES.html">OCaml Library Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="PS2OCAML.html">Translating ProScript to OCaml</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integration Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-principles">General Principles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ps2ocaml-usage">ps2ocaml Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interface-module">Interface Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interface-signature">Interface Signature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shims-module">Shims Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="PS2OCAML_FAQS.html">FAQs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="PSCL_JS_PROSCRIPT_API.html">pscl.js and the ProScript API</a></li>
<li class="toctree-l1"><a class="reference internal" href="KBB2017_FILES.html">File Structure for Auditing KBB2017</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Diskuv Implementations of Research Security Protocols</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="PS2OCAML.html">Translating ProScript to OCaml</a> &raquo;</li>
        
      <li>Integration Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/src-proscript/proscript-messaging/PS2OCAML_GUIDE.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="integration-guide">
<h1>Integration Guide<a class="headerlink" href="#integration-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general-principles">
<h2>General Principles<a class="headerlink" href="#general-principles" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ps2ocaml</span></code> is the tool you use to convert ProScript into OCaml. It was designed with the following tenets:</p>
<ul class="simple">
<li><p>When there is tension between performance, conciseness, idiomatic expression and statement-by-statement equivalence,
we always choose statement-by-statement equivalence because equivalence makes it relatively easy for any security
audit team to vet the translated code</p></li>
<li><p>When there is tension between knowingly producing correct code all the time and knowingly producing correct code 99.9%
of the time, we always choose 100% of the time but we leave an escape hatch that comes with a
comprehensive <strong>AUDIT NOTICE</strong> easily searchable (<code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-R</span> <span class="pre">&quot;AUDIT</span> <span class="pre">NOTICE&quot;</span> <span class="pre">.</span></code>) in the source code.</p></li>
</ul>
<p>The tenets reflect the primary focus of both ProScript and <code class="docutils literal notranslate"><span class="pre">dirsp</span></code> on secure code.</p>
<p>Statement by statement equivalence means each ProScript statement is translated to one OCaml expression. Here are some examples:</p>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Statement by statement equivalents</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 40%" />
<col style="width: 40%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ProScript Statement</p></th>
<th class="head"><p>OCaml Expression</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span>
<span class="cm">/* ... */</span>
</pre></div>
</div>
</td>
<td><div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">in</span>
<span class="c">(* ... *)</span>
</pre></div>
</div>
</td>
<td></td>
</tr>
<tr class="row-odd"><td><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">Type_key</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
<td><div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Type_key</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">construct</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">[]</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
<td></td>
</tr>
<tr class="row-even"><td><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">a</span><span class="p">.</span><span class="nx">field</span> <span class="o">=</span>
  <span class="nx">Type_key</span><span class="p">.</span><span class="nx">somefunc</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">field</span><span class="p">);</span>
</pre></div>
</div>
</td>
<td><div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">field</span> <span class="o">&lt;-</span>
  <span class="nn">Type_key</span><span class="p">.</span><span class="n">somefunc</span> <span class="n">a</span><span class="o">.</span><span class="n">field</span><span class="o">;</span>
</pre></div>
</div>
</td>
<td></td>
</tr>
<tr class="row-odd"><td><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">a</span><span class="p">.</span><span class="nx">field</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
</pre></div>
</div>
</td>
<td><div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="bp">true</span><span class="o">)</span> <span class="k">then</span>
  <span class="bp">()</span>
<span class="k">else</span>
  <span class="k">raise</span> <span class="o">(</span>
    <span class="nc">Invalid_argument</span>
      <span class="s2">&quot;not (a.field = true)&quot;</span>
  <span class="o">)</span>
</pre></div>
</div>
</td>
<td><p>a descriptive assert</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">a</span><span class="p">.</span><span class="nx">field</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
</pre></div>
</div>
</td>
<td><div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(_</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">=</span>
  <span class="c">(* no-op</span>
<span class="c">   statement-by-statement</span>
<span class="c">   equivalence *)</span>
  <span class="n">a</span><span class="o">.</span><span class="n">field</span> <span class="k">in</span> <span class="bp">()</span> <span class="o">;</span>
</pre></div>
</div>
</td>
<td><p>if you disable assertions</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ps2ocaml-usage">
<h2>ps2ocaml Usage<a class="headerlink" href="#ps2ocaml-usage" title="Permalink to this headline">¶</a></h2>
<p>Assuming you ran <code class="docutils literal notranslate"><span class="pre">opam</span> <span class="pre">install</span> <span class="pre">dirsp-ps2ocaml</span></code> and <code class="docutils literal notranslate"><span class="pre">eval</span> <span class="pre">$(opam</span> <span class="pre">env)</span></code>, you can run <code class="docutils literal notranslate"><span class="pre">dirsp-ps2ocaml</span></code>
from your shell.</p>
<p>Otherwise:</p>
<ul class="simple">
<li><p>Build the translator with <code class="docutils literal notranslate"><span class="pre">dune</span> <span class="pre">build</span> <span class="pre">src-proscript/dirsp_ps2ocaml.exe</span></code>. That
will produce a standalone executable at <code class="docutils literal notranslate"><span class="pre">&lt;dirsp-exchange&gt;/_build/default/src-proscript/dirsp-ps2ocaml.exe</span></code>
which you can run directly or use the shorthand <code class="docutils literal notranslate"><span class="pre">dune</span> <span class="pre">exec</span> <span class="pre">src-proscript/dirsp_ps2ocaml.exe</span></code>.</p></li>
<li><p>In everything that follows, use <code class="docutils literal notranslate"><span class="pre">dune</span> <span class="pre">exec</span> <span class="pre">src-proscript/dirsp_ps2ocaml.exe</span> <span class="pre">--</span></code> wherever you see
<code class="docutils literal notranslate"><span class="pre">dirsp-ps2ocaml</span></code>.</p></li>
</ul>
<p>The command line options are:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dirsp-ps2ocaml &lt;proscript_file&gt;
    [-i &lt;ocaml_interface_module&gt;]
    [-s &lt;ocaml_shims_module&gt;]
    (-p [&lt;module_name&gt;.]&lt;parameter_name&gt;:&lt;parameter_type&gt;)*
    [-disable_strictequals_assertions]
    [-apachev2license &lt;YYYY Owner&gt;]
    (-whitelist_module_for_letin &lt;module_name&gt;)*
    -o &lt;ocaml_output_file&gt;
</pre></div>
</div>
<p>When you are first starting you should just use the mandatory option (<code class="docutils literal notranslate"><span class="pre">-o</span></code>) and then add additional options
one at a time until your translated OCaml code compiles. Your first command will look something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dirsp-ps2ocaml -- src-proscript/proscript-messaging/ps/sp.js <span class="se">\</span>
    -o src-proscript/kobeissi_bhargavan_blanchet.ml
</pre></div>
</div>
<p>For KBB2017 this is done automatically as part of the build, but if we were to invoke it by hand we could run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dirsp-ps2ocaml -- src-proscript/proscript-messaging/ps/sp.js <span class="se">\</span>
    -p <span class="s2">&quot;them:t record_them&quot;</span> <span class="se">\</span>
    -p <span class="s2">&quot;msg:t record_msg&quot;</span> <span class="se">\</span>
    -p <span class="s2">&quot;Type_sendoutput.a:t record_sendoutput&quot;</span> <span class="se">\</span>
    -whitelist_module_for_letin TOPLEVEL <span class="se">\</span>
    -whitelist_module_for_letin HANDLE <span class="se">\</span>
    -disable_strictequals_assertions <span class="se">\</span>
    -o src-proscript/kobeissi_bhargavan_blanchet.ml
</pre></div>
</div>
<p>Let’s go through that complete command invocation from top to bottom:</p>
<ol class="arabic">
<li><p>ps2ocaml will take the ProScript file <code class="docutils literal notranslate"><span class="pre">src-proscript/proscript-messaging/ps/sp.js</span></code> and translate
it into an OCaml implementation at
<code class="docutils literal notranslate"><span class="pre">src-proscript/kobeissi_bhargavan_blanchet.ml</span></code>.</p>
<p>The generated implementation file will rely on other files you create manually. Each of those
manually created files has its own section in the documentation. They are:</p>
<ul class="simple">
<li><p>The <a class="reference internal" href="#interface-signature">Interface signature</a> file <code class="docutils literal notranslate"><span class="pre">kobeissi_bhargavan_blanchet.mli</span></code></p></li>
<li><p>The <a class="reference internal" href="#interface-module">Interface module</a> file <code class="docutils literal notranslate"><span class="pre">kobeissi_bhargavan_blanchet_intf.ml</span></code> (the naming is automatically derived from your <code class="docutils literal notranslate"><span class="pre">-o</span></code> option
unless you use the <code class="docutils literal notranslate"><span class="pre">-t</span></code> option)</p></li>
<li><p>The <a class="reference internal" href="#shims-module">Shims module</a> file <code class="docutils literal notranslate"><span class="pre">kobeissi_bhargavan_blanchet_shims.ml</span></code> (the naming is automatically derived from your <code class="docutils literal notranslate"><span class="pre">-o</span></code> option
unless you use the <code class="docutils literal notranslate"><span class="pre">-s</span></code> option)</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">-p</span></code> option lets us add type hints. OCaml is very good at inferring the types without you having to write type hints,
but occasionally it needs your help. With the options
<code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">&quot;them:t</span> <span class="pre">record_them&quot;</span> <span class="pre">-p</span> <span class="pre">&quot;msg:t</span> <span class="pre">record_msg&quot;</span> <span class="pre">-p</span> <span class="pre">&quot;Type_sendoutput.a:t</span> <span class="pre">record_sendoutput&quot;</span></code>:</p>
<ul class="simple">
<li><p>Any ProScript function parameter with the name <code class="docutils literal notranslate"><span class="pre">them</span></code> will be annotated with the <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">record_them</span></code> type
defined in the OCaml interface module described later.</p></li>
<li><p>Any <code class="docutils literal notranslate"><span class="pre">msg</span></code> parameter will be annotated with <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">record_msg</span></code>.</p></li>
<li><p>And any <code class="docutils literal notranslate"><span class="pre">a</span></code> parameter in a module <code class="docutils literal notranslate"><span class="pre">Type_sendoutput</span></code> will be annotated with <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">record_sendoutput</span></code>.</p></li>
</ul>
<p>For example, the ProScript function</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">tryDecrypt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">myIdentityKey</span><span class="p">,</span> <span class="nx">myEphemeralKey</span><span class="p">,</span> <span class="nx">them</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</pre></div>
</div>
<p>becomes</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">tryDecrypt</span> <span class="n">myIdentityKey</span> <span class="n">myEphemeralKey</span> <span class="o">(</span><span class="n">them</span> <span class="o">:</span> <span class="n">t</span> <span class="n">record_them</span><span class="o">)</span> <span class="o">(</span><span class="n">msg</span> <span class="o">:</span> <span class="n">t</span> <span class="n">record_msg</span><span class="o">)</span> <span class="o">=</span> <span class="k">begin</span> <span class="c">(* ... *)</span> <span class="k">end</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">Type_sendoutput</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>
    <span class="nx">assert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* ... */</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">Type_recvoutput</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>
    <span class="nx">assert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* ... */</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>becomes</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Type_sendoutput</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="c">(* ... *)</span>
    <span class="k">let</span> <span class="n">xassert</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">t</span> <span class="n">record_sendoutput</span><span class="o">)</span> <span class="o">=</span> <span class="c">(* ... *)</span>
<span class="k">end</span>
<span class="k">module</span> <span class="nc">Type_recvoutput</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="c">(* ... *)</span>
    <span class="k">let</span> <span class="n">xassert</span> <span class="n">a</span> <span class="o">=</span> <span class="c">(* ... *)</span>
<span class="k">end</span>
</pre></div>
</div>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">-whitelist_module_for_letin</span></code> option is an escape hatch to add when ps2ocaml cannot safely convert
the ProScript into equivalent OCaml. ps2ocaml will generate an implementation that won’t
compile, and when you look at the error in the generated source code it will tell you detailed instructions about how
to fix it, including the specific <code class="docutils literal notranslate"><span class="pre">-whitelist_module_for_letin</span></code> option you must use to enable the
escape hatch.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">disable_strictequals_assertions</span></code> option is an esoteric option you probably will not have to use.
It is documented in <a class="reference internal" href="PS2OCAML_FAQS.html#faq-disable-asserts"><span class="std std-ref">Question 4. How do I disable assertions?</span></a>.</p></li>
</ol>
</div>
<div class="section" id="interface-module">
<h2>Interface Module<a class="headerlink" href="#interface-module" title="Permalink to this headline">¶</a></h2>
<p>For KBB2017 the interface module file was
<a class="reference external" href="https://github.com/diskuv/dirsp-exchange/blob/main/src-proscript/kobeissi_bhargavan_blanchet_intf.ml">src-proscript/kobeissi_bhargavan_blanchet_intf.ml</a>.</p>
<p>The interface module has all the record types for any records your ProScript algorithm implicitly uses.</p>
<p>It also has any undefined parameter types that you use as annotations with the [(-p &lt;parameter_name:parameter_type&gt;)*] option.
- For example, with <code class="docutils literal notranslate"><span class="pre">ps2ocaml</span> <span class="pre">-p</span> <span class="pre">&quot;msg:t</span> <span class="pre">record_msg&quot;</span></code> you must have a <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">`a</span> <span class="pre">record_msg</span></code> defined.
- For example, with <code class="docutils literal notranslate"><span class="pre">ps2ocaml</span> <span class="pre">-p</span> <span class="pre">msg:string</span></code> nothing is needed since <code class="docutils literal notranslate"><span class="pre">string</span></code> is built-in.
- For example, with <code class="docutils literal notranslate"><span class="pre">ps2ocaml</span> <span class="pre">-p</span> <span class="pre">msg:Bigarray.int16_unsigned_elt</span></code> nothing is needed since <code class="docutils literal notranslate"><span class="pre">int16_unsigned_elt</span></code> was specified with a named module <code class="docutils literal notranslate"><span class="pre">Bigarray</span></code>.</p>
<p>An example you would include in the interface module that accounts for implicit record used in the following ProScript KBB2017 algorithm code</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">valid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">ephemeralKey</span><span class="o">:</span> <span class="nx">Type_key</span><span class="p">.</span><span class="nx">construct</span><span class="p">(),</span>
        <span class="nx">initEphemeralKey</span><span class="o">:</span> <span class="nx">Type_key</span><span class="p">.</span><span class="nx">construct</span><span class="p">(),</span>
        <span class="nx">ciphertext</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">iv</span><span class="o">:</span> <span class="nx">Type_iv</span><span class="p">.</span><span class="nx">construct</span><span class="p">(),</span>
        <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">preKeyId</span><span class="o">:</span> <span class="mf">0</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>is:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">record_msg</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">valid</span> <span class="o">:</span> <span class="kt">bool</span>
    <span class="o">;</span> <span class="k">mutable</span> <span class="n">ephemeralKey</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span>
    <span class="o">;</span> <span class="k">mutable</span> <span class="n">initEphemeralKey</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span>
    <span class="o">;</span> <span class="n">ciphertext</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span>
    <span class="o">;</span> <span class="k">mutable</span> <span class="n">iv</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span>
    <span class="o">;</span> <span class="n">tag</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span>
    <span class="o">;</span> <span class="n">preKeyId</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>In addition you must define a <code class="docutils literal notranslate"><span class="pre">PROTOCOL</span></code> type that declares the signatures for any ProScript functions where OCaml can’t infer their types, and
a <code class="docutils literal notranslate"><span class="pre">PROTOCOLFUNCTOR</span></code> and <code class="docutils literal notranslate"><span class="pre">PROTOCOLMODULE</span></code> that can instantiate it as follows:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">PROTOCOL</span> <span class="o">=</span> <span class="k">sig</span>
    <span class="c">(** The type that will be used to represent contiguous bytes in the protocol; typically Bytes.t or Cstruct.t *)</span>
    <span class="k">type</span> <span class="n">t</span>

    <span class="c">(** An internal type representing a decrypted AES message *)</span>
    <span class="k">type</span> <span class="n">t_aes_decrypted</span>

    <span class="c">(* Everything else below is optional, unless OCaml can&#39;t compile because it needs a signature for a function *)</span>

    <span class="k">module</span> <span class="nc">Type_key</span> <span class="o">:</span> <span class="k">sig</span>
        <span class="k">val</span> <span class="n">construct</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">t</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="k">type</span> <span class="nc">PROTOCOLFUNCTOR</span> <span class="o">=</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">ProScript</span> <span class="o">:</span> <span class="nn">Dirsp_proscript</span><span class="p">.</span><span class="nc">S</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="nc">PROTOCOL</span> <span class="k">with</span> <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">ProScript</span><span class="p">.</span><span class="n">t</span>

<span class="k">module</span> <span class="k">type</span> <span class="nc">PROTOCOLMODULE</span> <span class="o">=</span> <span class="k">sig</span>
    <span class="k">module</span> <span class="nc">Make</span><span class="o">:</span> <span class="nc">PROTOCOL</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">PROTOCOL</span></code> is also a great place to put in documentation!</p>
<p>Tip: You can instantiate your machine translated module in <code class="docutils literal notranslate"><span class="pre">utop</span></code> and then <code class="docutils literal notranslate"><span class="pre">#show</span></code> it to generate a complete signature of your ProScript code. Use
that signature as your Protocol, replace any references to <code class="docutils literal notranslate"><span class="pre">ProScript.t</span></code> with <code class="docutils literal notranslate"><span class="pre">t</span></code>, and then document each signature.</p>
</div>
<div class="section" id="interface-signature">
<h2>Interface Signature<a class="headerlink" href="#interface-signature" title="Permalink to this headline">¶</a></h2>
<p>For KBB2017 the interface signature file was
<a class="reference external" href="https://github.com/diskuv/dirsp-exchange/blob/main/src-proscript/kobeissi_bhargavan_blanchet.mli">src-proscript/kobeissi_bhargavan_blanchet.mli</a>.</p>
<p>You simply need to <code class="docutils literal notranslate"><span class="pre">include</span></code> the <code class="docutils literal notranslate"><span class="pre">PROTOCOLMODULE</span></code> of your interface module. Here is an example:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="c">(* filename: kobeissi_bhargavan_blanchet.mli *)</span>

<span class="c">(* Use whichever _intf module you defined earlier *)</span>
<span class="c">(** @inline *)</span>
<span class="k">include</span> <span class="nn">Kobeissi_bhargavan_blanchet_intf</span><span class="p">.</span><span class="nc">PROTOCOLMODULE</span>
</pre></div>
</div>
</div>
<div class="section" id="shims-module">
<h2>Shims Module<a class="headerlink" href="#shims-module" title="Permalink to this headline">¶</a></h2>
<p>For KBB2017 the shims module file was
<a class="reference external" href="https://github.com/diskuv/dirsp-exchange/blob/main/src-proscript/kobeissi_bhargavan_blanchet_shims.ml">src-proscript/kobeissi_bhargavan_blanchet_shims.ml</a>.</p>
<p>The shims module needs to contain a <code class="docutils literal notranslate"><span class="pre">Make</span></code> functor that defines all functions in your ProScript algorithm
that can’t be machine translated into OCaml. Even if all functions can be machine translated, the <code class="docutils literal notranslate"><span class="pre">Make</span></code> functor
must still exist.</p>
<p>Here is an example:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="c">(* filename: kobeissi_bhargavan_blanchet_shims.ml *)</span>

<span class="c">(* Use whichever _intf module you defined earlier *)</span>
<span class="k">include</span> <span class="n">kobeissi_bhargavan_blanchet_intf</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="o">(</span><span class="nc">ProScript</span> <span class="o">:</span> <span class="nn">Proscript</span><span class="p">.</span><span class="nc">S</span><span class="o">)</span> <span class="o">:</span> <span class="nc">Protocol</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="c">(**</span>
<span class="c">      In KBB2017, we had the following ProScript algorithm code that did not convert:</span>

<span class="c">      {v</span>
<span class="c">            const UTIL = {</span>
<span class="c">                newKeyPair: function(id) {</span>
<span class="c">                    const priv = ProScript.Crypto.random32Bytes(&#39;aPK&#39; + id);</span>
<span class="c">                    return {</span>
<span class="c">                        priv: priv,</span>
<span class="c">                        pub: ProScript.Crypto.DH25519(priv, [</span>
<span class="c">                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span>
<span class="c">                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span>
<span class="c">                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span>
<span class="c">                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09</span>
<span class="c">                        ])</span>
<span class="c">                    };</span>
<span class="c">                }</span>
<span class="c">            }</span>
<span class="c">       v}</span>

<span class="c">       That Javascript function will be replaced by your hand-written [shim_UTIL_newKeyPair]</span>
<span class="c">       in this module.</span>
<span class="c">     *)</span>

    <span class="k">let</span> <span class="n">shim_UTIL_newKeyPair</span> <span class="n">id</span> <span class="o">=</span>
        <span class="k">let</span> <span class="n">priv</span> <span class="o">=</span> <span class="nn">ProScript</span><span class="p">.</span><span class="nn">Crypto</span><span class="p">.</span><span class="n">random32Bytes</span> <span class="o">(</span><span class="nn">ProScript</span><span class="p">.</span><span class="n">concat</span> <span class="o">[</span> <span class="nn">ProScript</span><span class="p">.</span><span class="n">of_string</span> <span class="s2">&quot;aID&quot;</span><span class="o">;</span> <span class="n">id</span> <span class="o">])</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">byte</span> <span class="o">=</span> <span class="nn">ProScript</span><span class="p">.</span><span class="n">elem_of_char</span> <span class="k">in</span>
        <span class="o">{</span>
            <span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="o">;</span>
            <span class="n">pub</span> <span class="o">=</span> <span class="nn">ProScript</span><span class="p">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">xDH25519</span> <span class="n">priv</span> <span class="o">(</span><span class="nn">ProScript</span><span class="p">.</span><span class="n">of_elem_list</span> <span class="o">[</span>
                <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span>
                <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span>
                <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span>
                <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x00&#39;</span><span class="o">;</span> <span class="n">byte</span> <span class="sc">&#39;\x09&#39;</span>
            <span class="o">])</span>
        <span class="o">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="PS2OCAML_FAQS.html" class="btn btn-neutral float-right" title="FAQs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="PS2OCAML.html" class="btn btn-neutral float-left" title="Translating ProScript to OCaml" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Diskuv, Inc..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>